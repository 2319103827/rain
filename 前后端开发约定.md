前后端开发约定
============

AJAX 交互约定
------------

URL 如无特殊约定一律使用 `/ajax/` 作为前缀，以下划线分隔。例如:

```
/ajax/get_news/
/ajax/get_goods.php
```

AJAX 一律使用 JSON 格式。

默认成功返回 JSON：

```javascript
{
    "status": "success"
}
```

默认失败返回 JSON：

```javascript
{
    "status": "error",
    "msg": "error detail"
}
```
注意需要用户登录状态下才能请求成功的 AJAX 在用户没有登录时候应当返回：  

```javascript
{
    "status": "error",
    "msg": "您没有权限进行此操作，请检查您是否登录"
}

// 或通过前后端约定后返回（约定的作用在于前端可以通过 nologin 的标识判断错误类型，从而自由的控制错误UI）

{
    "status": "nologin",
}
```
### JSON常用参数约定

#### msg


```javascript
{   
    "status:": "error",
    "msg": "您已经赞过人"
}
```
msg 是 message 的缩写，用于存放消息


#### src

```javascript
{   
    "status:": "success",
    "src": "http://www.domain.com/xxx/demo.jpg"
}
```
src 是图片视频等资源的在线地址

#### val

```javascript
{
    "status":"success",
    "val":"pic_739515",
    "src":"http://www.domain.com/xxx/demo.jpg"
}
```
val 用于保存会提交给后端的数据，列如：  
用户上传头像，前端通过 AJAX 向 `/ajax/uploader/` 上传图片后，后端返回数据后前端将 src 中的图片在浏览器展示出来，并将 val 中的 "pic_739515" 保存在 `<input type="hidden" name="pic_value" value="pic_739515">` 中当用户保存信息时候将 `pic_739515` 一起提交给后端。

#### url

```javascript
{   
    "status:": "success",
    "url": "/article/?id=3"
}
```
url 是页面路径信息，列如：  
前端提交一个发布文章的 AJAX ，后端返回数据后前端在页面弹窗提示:

```javascript
您已经成提交，请<a href="/article/?id=3">点击此处</a>查看文章
```

注意：不要将url 与 src 混淆，src 用于存放图片视频等资源，url 用于存放页面地址.


#### view

```javascript
{
    viwe: [
        {
            title: '第87届奥斯卡金像奖红毯秀',
            time: '2015-02-23  06:14:00',
            link: '/news/?id=3'
        },
        {
            title: '美国民众暴雪天气中跳楼取乐',
            time: '2015-02-22 04:12:37',
            link: '/news/?id=2'
        },
        {
            title: '金正恩主持朝鲜党中央军委扩大会议',
            time: '2015-02-21 10:32:11',
            link: '/news/?id=1'
        }
    ]
}

```

view 用于存放一些需要前端渲染的数据，例如：  
前端发送AJAX获取新闻列表，后端将列表数据存放在 view 中，前端接受到数据在浏览渲染成：


```html
<!-- 模板 -->
<ul>
    {{#view}}
    <li>
        <a href="{{link}}">{{title}}</a>
        发布于：{{time}}
    </li>
    {{/view}}
</ul>
```

```html
<!-- 渲染结果 -->
    <ul>
        <li>
            <a href="/news/?id=3">第87届奥斯卡金像奖红毯秀</a>
            发布于：2015-02-23  06:14:00
        </li>
        <li>
            <a href="/news/?id=2">美国民众暴雪天气中跳楼取乐</a>
            发布于：2015-02-22 04:12:37
        </li>
        <li>
            <a href="/news/?id=1">金正恩主持朝鲜党中央军委扩大会议</a>
            发布于：2015-02-21 10:32:11
        </li>
    </ul>
```

### 文件上传AJAX

文件上传一律使用 `/ajax/uploader/`，返回数据格式如下：

```javascript
{
    "status": "success",
    "val": "3157137",
    "src": "http://www.domain.com/xxx/demo.jpg"

}
// 失败时返回
{
    "status": "error",
    "msg": "详细错误原因"
}
```

文件上传域的name 默认为 `file`


项目启动前的技术选型
----------------
要解决的痛点：**后端将前端html“翻译”成后端模板引擎**

如下：

```html
<!-- 前端HTML -->
<html>
<head>
    <title>页面标题</title>
</head>
<body>
    <!-- 免费用户状态 -->
    <ul>
        <li>欢迎你， Nimo</li>
    </ul>
    <!-- 付费用户状态 -->
    <ul>
        <li>欢迎你，会员 Nimo</li>
        <li><a href="/email/">收取邮件</a></li>
    </ul>
</body>
</html>
```

```php
<!-- php 直接解析 -->
<?php include "header_1.php" ?>
<title>页面标题</title>
<?php include "header_2.php" ?>
<ul>
    <li>
    欢迎你，
    <?php echo $status === "free"? "普通会员": "会员"; ?>
    <?php echo $username ?>
    </li>
    <?php echo $status === 'free'? '': '<li><a href="/email/">收取邮件</a></li>'; ?>
</ul>
<?php include "footer.php" ?>
或者
<!-- smart 模板渲染 -->
{include file="header_1.tpl"}
<title>页面标题</title>
{include file="header_2.tpl"}
<ul>
    <li>
    欢迎你，
    {if $status=='free'}
        普通会员
    {else}
        会员
    {/if}
    {username}
    </li>
    {if $status=='free'}
        <li><a href="/email/">收取邮件</a></li>
    {/if}
    {username}
</ul>
{include file="footer.tpl"}
```

以上是一个简单的HTML“翻译”工作。复杂的模板翻译 HTML 输出逻辑复杂，经常会出现最终结果与前端 Demo 输出不一致。增加大量的联调和沟通的工作量。

团队考虑三种页面渲染方案：

1. SPA(Single-page application) 所有用到的展现数据都是后端通过异步接口(AJAX/JSONP)的方式提供的。由后端提供JSON数据，前端渲染HTML。
2. 后端使用 lightncandy 语法的模板引擎，由前端编写后端模板。后端专注在 controller 向 view 输出数据，前端Demo 等同于 后端模板。
3. 由后端自定模板引擎，后端根据前端 Demo 编写后端模板。前端维护前端demo，开发和功能更新时后端根据前端Demo "翻译" 成后端模板引擎。

前端对以上三种方式的观点：

一、 SPA 的方式适合于 Web 应用型产品和 Web app

二、 非 SPA 项目推荐这种方式。View 的开发工作由前端担任后后端只需要关心提供数据服务，让每个人做各自更了解更擅长的事。  
但需要后端开发框架的的配合，需要开发框架支持 类似 lightncandy 的 Handlebars 语法模板引擎。并提供简洁的模板引擎渲染API（前端会在后端框架中编写Controller 传递给 View 的模拟数据，模拟页面渲染）。

三、 若使用此方式，可事先约定好后端加载公用文件的语法。前端编写 Demo 时兼容此语法，示例：

```php
<!--
    如果后端加载公用页面的语法是 <?php include "filename" ?> 则前端会交付如下 HTML 给后端，方便后端同事的“翻译”工作
-->
<?php include "header_1.php" ?>
<title>页面标题</title>
<?php include "header_2.php" ?>
内容
<?php include "footer.php" ?>
```